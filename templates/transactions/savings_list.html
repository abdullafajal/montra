{% extends "base.html" %}
{% load core_tags %}

{% block title %}Savings Goals{% endblock %}

{% block top_bar %}
<div class="px-5 pt-6 pb-2 lg:px-6 lg:pt-8 flex items-center justify-between">
    <div class="flex items-center gap-3">
        <a href="{% url 'transactions:dashboard' %}" class="w-10 h-10 rounded-xl bg-m3-surface-container-high dark:bg-m3-surface-container-high-dark flex items-center justify-center hover:bg-m3-surface-container-highest transition-colors lg:hidden">
            <span class="material-symbols-outlined icon-md text-m3-on-surface dark:text-m3-on-surface-dark">arrow_back</span>
        </a>
        <h1 class="text-xl font-bold text-m3-on-surface dark:text-m3-on-surface-dark">Savings Goals</h1>
    </div>
    <a href="{% url 'transactions:savings_create' %}" class="w-10 h-10 lg:w-auto lg:px-4 lg:py-2.5 rounded-xl lg:rounded-3xl bg-m3-primary-container dark:bg-m3-primary-container-dark flex items-center justify-center lg:gap-2 hover:opacity-90 transition-colors">
        <span class="material-symbols-outlined icon-md text-m3-on-primary-container dark:text-m3-on-primary-container-dark">add</span>
        <span class="hidden lg:inline text-sm font-medium text-m3-on-primary-container dark:text-m3-on-primary-container-dark">New Goal</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="animate-fade-in grid grid-cols-1 lg:grid-cols-2 gap-3">
    {% for goal in goals %}
    {% with pct=goal.get_percentage remaining=goal.get_remaining %}
    <div class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-4 {% if goal.is_completed %}opacity-75{% endif %}">
        <!-- Header -->
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2.5">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background-color: {{ goal.color }}15;">
                    <span class="material-symbols-outlined" style="color: {{ goal.color }}; font-size: 22px;">{{ goal.icon }}</span>
                </div>
                <div>
                    <p class="text-sm font-medium text-m3-on-surface dark:text-m3-on-surface-dark">{{ goal.name }}</p>
                    {% if goal.deadline %}
                    <p class="text-xs text-m3-outline dark:text-m3-outline-dark">
                        <span class="material-symbols-outlined" style="font-size:12px;vertical-align:middle;">event</span>
                        {{ goal.deadline|date:"M d, Y" }}
                    </p>
                    {% endif %}
                </div>
            </div>
            <div class="flex gap-1">
                {% if goal.is_completed %}
                <div class="px-2.5 py-1 bg-green-100 dark:bg-green-900/20 rounded-full">
                    <span class="text-xs font-bold text-income-dark dark:text-income">âœ“ Done</span>
                </div>
                {% endif %}
                <a href="{% url 'transactions:savings_update' goal.pk %}" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-m3-surface-container-high dark:hover:bg-m3-surface-container-high-dark transition-colors">
                    <span class="material-symbols-outlined icon-sm text-m3-outline dark:text-m3-outline-dark">edit</span>
                </a>
                <a href="{% url 'transactions:savings_delete' goal.pk %}" class="w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                    <span class="material-symbols-outlined icon-sm text-m3-outline dark:text-m3-outline-dark">delete</span>
                </a>
            </div>
        </div>

        <!-- Progress Bar -->
        <div>
            <div class="flex justify-between text-xs mb-1.5">
                <span class="text-m3-outline dark:text-m3-outline-dark">{{ goal.current_amount|currency:currency_symbol }} saved</span>
                <span class="font-medium {% if goal.is_completed %}text-income-dark dark:text-income{% else %}text-m3-on-surface dark:text-m3-on-surface-dark{% endif %}">{{ pct }}%</span>
            </div>
            <div class="w-full h-2.5 bg-m3-surface-container-highest dark:bg-m3-surface-container-highest-dark rounded-full overflow-hidden">
                <div class="h-full rounded-full transition-all duration-500 {% if goal.is_completed %}bg-income{% elif pct > 75 %}bg-amber-500{% else %}bg-m3-primary dark:bg-m3-primary-dark{% endif %}" style="width: {{ pct }}%;"></div>
            </div>
            <div class="flex justify-between text-xs mt-1.5 text-m3-outline dark:text-m3-outline-dark">
                <span>{{ currency_symbol }}0</span>
                <span>{{ goal.target_amount|currency:currency_symbol }}</span>
            </div>
        </div>

        <!-- Remaining + Add Money -->
        {% if not goal.is_completed %}
        <div class="flex items-center justify-between mt-3 pt-3 border-t border-m3-outline-variant/30 dark:border-m3-outline-variant-dark/30">
            <p class="text-xs text-m3-outline dark:text-m3-outline-dark">
                <span class="font-medium text-m3-on-surface dark:text-m3-on-surface-dark">{{ remaining|currency:currency_symbol }}</span> remaining
            </p>
            <form method="post" action="{% url 'transactions:savings_add_money' goal.pk %}" class="flex items-center gap-2">
                {% csrf_token %}
                <input type="number" name="amount" placeholder="0.00" step="0.01" min="0.01" required
                       class="w-24 px-3 py-1.5 text-xs rounded-xl border border-m3-outline-variant dark:border-m3-outline-variant-dark bg-m3-surface-container-high dark:bg-m3-surface-container-high-dark text-m3-on-surface dark:text-m3-on-surface-dark outline-none focus:ring-1 focus:ring-m3-primary">
                <button type="submit" class="px-3 py-1.5 bg-income text-white text-xs font-medium rounded-xl hover:bg-income-dark transition-colors active:scale-95">
                    + Add
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    {% endwith %}
    {% empty %}
    <div class="col-span-full text-center py-16">
        <span class="material-symbols-outlined text-m3-outline-variant dark:text-m3-outline-variant-dark" style="font-size:56px;">flag</span>
        <p class="text-m3-outline dark:text-m3-outline-dark font-medium mt-2">No savings goals yet</p>
        <p class="text-xs text-m3-outline dark:text-m3-outline-dark mt-1">Start saving towards your dreams!</p>
        <a href="{% url 'transactions:savings_create' %}" class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 bg-m3-primary dark:bg-m3-primary-dark text-m3-on-primary dark:text-m3-on-primary-dark text-sm font-medium rounded-3xl hover:opacity-90 transition-colors">
            <span class="material-symbols-outlined icon-sm">add</span>
            Create Goal
        </a>
    </div>
    {% endfor %}
</div>
{% endblock %}
