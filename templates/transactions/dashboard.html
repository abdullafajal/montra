{% extends "base.html" %}
{% load core_tags %}

{% block title %}Dashboard{% endblock %}

{% block top_bar %}
<div class="px-5 pt-6 pb-2 lg:px-6 lg:pt-8 flex items-center justify-between">
    <div>
        <p class="text-sm text-m3-outline dark:text-m3-outline-dark">Good {{ greeting }},</p>
        <h1 class="text-xl font-bold text-m3-on-surface dark:text-m3-on-surface-dark">{{ request.user.get_full_name|default:request.user.username }}</h1>
    </div>
    <a href="{% url 'accounts:profile' %}" class="w-10 h-10 bg-m3-primary-container dark:bg-m3-primary-container-dark rounded-full flex items-center justify-center text-m3-on-primary-container dark:text-m3-on-primary-container-dark font-bold text-sm">
        {{ request.user.username|make_list|first|upper }}
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Balance Card -->
<div class="bg-gradient-to-br from-[#37474F] to-[#546E7A] dark:from-[#263238] dark:to-[#37474F] rounded-3xl p-6 text-white animate-fade-in">
    <p class="text-sm font-medium opacity-80 mb-1">Total Balance</p>
    <h2 class="text-3xl font-bold tracking-tight">{{ total_balance|currency:currency_symbol }}</h2>
    <div class="grid grid-cols-3 gap-3 mt-5">
        <div class="bg-white/15 dark:bg-white/10 rounded-2xl p-3 backdrop-blur-sm">
            <div class="flex items-center gap-1.5 mb-1">
                <span class="material-symbols-outlined icon-sm text-green-300">arrow_upward</span>
                <span class="text-xs opacity-80">Income</span>
            </div>
            <p class="text-sm font-bold">{{ monthly_income|currency:currency_symbol }}</p>
        </div>
        <div class="bg-white/15 dark:bg-white/10 rounded-2xl p-3 backdrop-blur-sm">
            <div class="flex items-center gap-1.5 mb-1">
                <span class="material-symbols-outlined icon-sm text-red-300">arrow_downward</span>
                <span class="text-xs opacity-80">Expenses</span>
            </div>
            <p class="text-sm font-bold">{{ monthly_expenses|currency:currency_symbol }}</p>
        </div>
        <div class="bg-white/15 dark:bg-white/10 rounded-2xl p-3 backdrop-blur-sm">
            <div class="flex items-center gap-1.5 mb-1">
                <span class="material-symbols-outlined icon-sm text-amber-300">savings</span>
                <span class="text-xs opacity-80">Savings</span>
            </div>
            <p class="text-sm font-bold">{{ monthly_savings|currency:currency_symbol }}</p>
        </div>
    </div>
</div>

<!-- Budget Warnings -->
{% if budget_warnings %}
<div class="mt-4 space-y-2 animate-fade-in stagger-1">
    {% for b in budget_warnings %}
    <div class="flex items-center gap-3 px-4 py-3 bg-red-100 dark:bg-red-900/20 rounded-xl">
        <span class="material-symbols-outlined icon-sm text-m3-error dark:text-m3-error-dark">warning</span>
        <p class="text-sm text-m3-error dark:text-m3-error-dark font-medium">{{ b.category.name }} budget exceeded!</p>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Insights -->
{% if insights %}
<div class="mt-4 space-y-2 animate-fade-in stagger-1">
    {% for insight in insights %}
    <div class="flex items-center gap-3 bg-m3-primary-container/50 dark:bg-m3-primary-container-dark/50 rounded-xl px-4 py-3">
        <span class="material-symbols-outlined icon-sm text-m3-primary dark:text-m3-primary-dark">lightbulb</span>
        <p class="text-sm text-m3-on-primary-container dark:text-m3-on-primary-container-dark">{{ insight }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Charts Grid -->
<div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4 animate-fade-in stagger-2">
    <!-- Spending by Category (Horizontal Bar) -->
    <div class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-5">
        <h3 class="text-sm font-bold text-m3-on-surface dark:text-m3-on-surface-dark mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined icon-sm text-m3-primary dark:text-m3-primary-dark">bar_chart</span>
            Spending by Category
        </h3>
        <canvas id="pieChart" height="220"></canvas>
    </div>

    <!-- Income vs Expense (Bar) -->
    <div class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-5">
        <h3 class="text-sm font-bold text-m3-on-surface dark:text-m3-on-surface-dark mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined icon-sm text-m3-primary dark:text-m3-primary-dark">bar_chart</span>
            Income vs Expenses
        </h3>
        <canvas id="barChart" height="200"></canvas>
    </div>
</div>

<!-- Spending Trend (Line) -->
<div class="mt-4 animate-fade-in stagger-3">
    <div class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-5">
        <h3 class="text-sm font-bold text-m3-on-surface dark:text-m3-on-surface-dark mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined icon-sm text-m3-primary dark:text-m3-primary-dark">show_chart</span>
            30-Day Spending Trend
        </h3>
        <canvas id="lineChart" height="160"></canvas>
    </div>
</div>

<!-- Recent Transactions -->
<div class="mt-6 animate-fade-in stagger-4">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-bold text-m3-on-surface dark:text-m3-on-surface-dark">Recent Transactions</h3>
        <a href="{% url 'transactions:list' %}" class="text-sm font-medium text-m3-primary dark:text-m3-primary-dark hover:underline">See All</a>
    </div>
    <div class="space-y-2">
        {% for txn in recent_transactions %}
        <a href="{% url 'transactions:update' txn.pk %}" class="flex items-center gap-3 bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-4 hover:bg-m3-surface-container-high dark:hover:bg-m3-surface-container-high-dark transition-colors active:scale-[0.99]">
            <div class="w-11 h-11 rounded-xl flex items-center justify-center" style="background-color: {{ txn.category.color }}20;">
                <span class="material-symbols-outlined" style="color: {{ txn.category.color }}; font-size: 22px;">{{ txn.category.icon }}</span>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-m3-on-surface dark:text-m3-on-surface-dark truncate">{{ txn.category.name }}</p>
                <p class="text-xs text-m3-outline dark:text-m3-outline-dark">{{ txn.date|date:"M d, h:i A" }} · {{ txn.get_payment_method_display }}</p>
            </div>
            <span class="text-sm font-bold {% if txn.type == 'income' %}text-income{% else %}text-expense{% endif %}">
                {% if txn.type == 'income' %}+{% else %}-{% endif %}{{ txn.amount|currency:currency_symbol }}
            </span>
        </a>
        {% empty %}
        <div class="text-center py-10">
            <span class="material-symbols-outlined text-m3-outline dark:text-m3-outline-dark" style="font-size:48px;">receipt_long</span>
            <p class="text-sm text-m3-outline dark:text-m3-outline-dark mt-2">No transactions yet.</p>
            <a href="{% url 'transactions:create' %}" class="inline-block mt-3 text-sm font-medium text-m3-primary dark:text-m3-primary-dark hover:underline">Add your first transaction →</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Quick Links -->
<div class="mt-6 grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4 animate-fade-in stagger-4">
    <a href="{% url 'transactions:budget_list' %}" class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-4 hover:bg-m3-surface-container-high dark:hover:bg-m3-surface-container-high-dark transition-colors active:scale-[0.98]">
        <span class="material-symbols-outlined text-m3-primary dark:text-m3-primary-dark icon-lg">savings</span>
        <p class="text-sm font-medium text-m3-on-surface dark:text-m3-on-surface-dark mt-2">Budgets</p>
        <p class="text-xs text-m3-outline dark:text-m3-outline-dark">Set spending limits</p>
    </a>
    <a href="{% url 'transactions:savings_list' %}" class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-4 hover:bg-m3-surface-container-high dark:hover:bg-m3-surface-container-high-dark transition-colors active:scale-[0.98]">
        <span class="material-symbols-outlined text-m3-primary dark:text-m3-primary-dark icon-lg">flag</span>
        <p class="text-sm font-medium text-m3-on-surface dark:text-m3-on-surface-dark mt-2">Savings</p>
        <p class="text-xs text-m3-outline dark:text-m3-outline-dark">Track your goals</p>
    </a>
    <a href="{% url 'transactions:category_list' %}" class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-4 hover:bg-m3-surface-container-high dark:hover:bg-m3-surface-container-high-dark transition-colors active:scale-[0.98]">
        <span class="material-symbols-outlined text-m3-primary dark:text-m3-primary-dark icon-lg">category</span>
        <p class="text-sm font-medium text-m3-on-surface dark:text-m3-on-surface-dark mt-2">Categories</p>
        <p class="text-xs text-m3-outline dark:text-m3-outline-dark">Organize spending</p>
    </a>
    <a href="{% url 'reports:export_csv' %}" class="bg-m3-surface-container dark:bg-m3-surface-container-dark rounded-2xl p-4 hover:bg-m3-surface-container-high dark:hover:bg-m3-surface-container-high-dark transition-colors active:scale-[0.98]">
        <span class="material-symbols-outlined text-m3-primary dark:text-m3-primary-dark icon-lg">download</span>
        <p class="text-sm font-medium text-m3-on-surface dark:text-m3-on-surface-dark mt-2">Export</p>
        <p class="text-xs text-m3-outline dark:text-m3-outline-dark">Download CSV</p>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const isDark = document.documentElement.classList.contains('dark');
    const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
    const textColor = isDark ? '#8A969E' : '#6E7B84';

    Chart.defaults.font.family = "'Roboto', sans-serif";
    Chart.defaults.font.size = 11;
    Chart.defaults.color = textColor;

    // Category Horizontal Bar
    const pieLabels = {{ pie_labels|safe }};
    const pieValues = {{ pie_values|safe }};
    const pieColors = {{ pie_colors|safe }};

    if (pieLabels.length > 0) {
        new Chart(document.getElementById('pieChart'), {
            type: 'bar',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieValues,
                    backgroundColor: pieColors,
                    borderRadius: 6,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { color: gridColor }, border: { display: false }, ticks: { font: { size: 10 } } },
                    y: { grid: { display: false }, ticks: { font: { size: 11, weight: '500' } } }
                }
            }
        });
    }

    // Bar Chart
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: {{ bar_labels|safe }},
            datasets: [
                { label: 'Income', data: {{ bar_income|safe }}, backgroundColor: '#4DB6AC', borderRadius: 8, barPercentage: 0.6 },
                { label: 'Expenses', data: {{ bar_expense|safe }}, backgroundColor: '#78909C', borderRadius: 8, barPercentage: 0.6 }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom', labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' } } },
            scales: { x: { grid: { display: false } }, y: { grid: { color: gridColor }, border: { display: false } } }
        }
    });

    // Line Chart
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: {{ line_labels|safe }},
            datasets: [{
                label: 'Daily Expenses',
                data: {{ line_values|safe }},
                borderColor: '#455A64',
                backgroundColor: isDark ? 'rgba(176,190,197,0.1)' : 'rgba(69,90,100,0.1)',
                fill: true, tension: 0.4, borderWidth: 2.5,
                pointRadius: 0, pointHoverRadius: 5,
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 7 } }, y: { grid: { color: gridColor }, border: { display: false } } }
        }
    });
</script>
{% endblock %}
